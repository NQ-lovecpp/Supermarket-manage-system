{% extends "base.html" %}

{% block title %}供应商管理{% endblock %}

{% block content %}
<h1>供应商管理</h1>

<div class="actions">
    <button id="addSupplierBtn">添加供应商</button>
    <input type="text" id="searchSupplier" placeholder="搜索供应商...">
</div>

<table id="supplierTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>名称</th>
            <th>联系人</th>
            <th>电话</th>
            <th>地址</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for supplier in suppliers %}
        <tr>
            <td>{{ supplier.supplier_id }}</td>
            <td>{{ supplier.name }}</td>
            <td>{{ supplier.contact_person }}</td>
            <td>{{ supplier.phone }}</td>
            <td>{{ supplier.address }}</td>
            <td>
                <button class="editSupplierBtn" data-id="{{ supplier.supplier_id }}">修改</button>
                <button class="deleteSupplierBtn" data-id="{{ supplier.supplier_id }}">删除</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="addSupplierModal" class="modal">
    <div class="modal-content">
        <h2>添加供应商</h2>
        <form id="addSupplierForm">
            <label for="name">名称:</label>
            <input type="text" id="name" name="name" required>

            <label for="contact_person">联系人:</label>
            <input type="text" id="contact_person" name="contact_person" required>

            <label for="phone">电话:</label>
            <input type="tel" id="phone" name="phone" required>

            <label for="address">地址:</label>
            <input type="text" id="address" name="address" required>

            <button type="submit">保存</button>
            <button type="button" class="closeModal">取消</button>
        </form>
    </div>
</div>

<div id="editSupplierModal" class="modal">
    <div class="modal-content">
        <h2>修改供应商</h2>
        <form id="editSupplierForm">
            <input type="hidden" id="editSupplierId" name="id">

            <label for="editName">名称:</label>
            <input type="text" id="editName" name="name" required>

            <label for="editContactPerson">联系人:</label>
            <input type="text" id="editContactPerson" name="contact_person" required>

            <label for="editPhone">电话:</label>
            <input type="tel" id="editPhone" name="phone" required>

            <label for="editAddress">地址:</label>
            <input type="text" id="editAddress" name="address" required>

            <button type="submit">保存</button>
            <button type="button" class="closeModal">取消</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 添加供应商
    document.getElementById('addSupplierBtn').addEventListener('click', function() {
        document.getElementById('addSupplierModal').style.display = 'block';
    });

    document.getElementById('addSupplierForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch("{{ url_for('supplier.add_supplier') }}", {
            method: 'POST',
            body: new FormData(this)
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('添加供应商失败');
            }
        });
    });

    // 修改供应商
    document.querySelectorAll('.editSupplierBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            const supplierId = this.getAttribute('data-id');
            fetch(`/supplier/${supplierId}`)
            .then(response => response.json())
            .then(supplier => {
                document.getElementById('editSupplierId').value = supplier.supplier_id;
                document.getElementById('editName').value = supplier.name;
                document.getElementById('editContactPerson').value = supplier.contact_person;
                document.getElementById('editPhone').value = supplier.phone;
                document.getElementById('editAddress').value = supplier.address;
                document.getElementById('editSupplierModal').style.display = 'block';
            });
        });
    });

    document.getElementById('editSupplierForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const supplierId = document.getElementById('editSupplierId').value;
        fetch(`{{ url_for('supplier.edit_supplier', id=0) }}`.replace('0', supplierId), {
            method: 'POST',
            body: new FormData(this)
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('修改供应商失败');
            }
        });
    });

    // 删除供应商
    document.querySelectorAll('.deleteSupplierBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('确定要删除这个供应商吗？')) {
                const supplierId = this.getAttribute('data-id');
                fetch(`{{ url_for('supplier.delete_supplier', id=0) }}`.replace('0', supplierId), {
                    method: 'POST'
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('删除供应商失败');
                    }
                });
            }
        });
    });

    // 搜索供应商
    document.getElementById('searchSupplier').addEventListener('input', function() {
        const query = this.value;
        fetch(`{{ url_for('supplier.search_supplier') }}?query=${query}`)
        .then(response => response.json())
        .then(suppliers => {
            const tbody = document.querySelector('#supplierTable tbody');
            tbody.innerHTML = '';
            suppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${supplier.id}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.contact_person}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.address}</td>
                    <td>
                        <button class="editSupplierBtn" data-id="${supplier.id}">修改</button>
                        <button class="deleteSupplierBtn" data-id="${supplier.id}">删除</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });
    });

    // 关闭模态框
    document.querySelectorAll('.closeModal').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
</script>
{% endblock %}