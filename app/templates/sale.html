{% extends "base.html" %}

{% block title %}销售管理{% endblock %}

{% block content %}
<h1>销售管理</h1>

<div class="actions">
    <button id="addSaleBtn">新增销售记录</button>
    <input type="date" id="startDate" placeholder="开始日期">
    <input type="date" id="endDate" placeholder="结束日期">
    <select id="employeeFilter">
        <option value="">所有员工</option>
        {% for employee in employees %}
        <option value="{{ employee.employee_id }}">{{ employee.name }}</option>
        {% endfor %}
    </select>
    <button id="searchSaleBtn">搜索</button>
</div>

<div id="saleStatistics">
    <p>总销售额: <span id="totalAmount">0</span></p>
    <p>总销售量: <span id="totalQuantity">0</span></p>
</div>

<table id="saleTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>商品名称</th>
            <th>数量</th>
            <th>单价</th>
            <th>总价</th>
            <th>销售日期</th>
            <th>销售员</th>
        </tr>
    </thead>
    <tbody>
        {% for sale in sales %}
        <tr>
            <td>{{ sale.sale_id }}</td>
            <td>{{ sale.product.name }}</td>
            <td>{{ sale.quantity }}</td>
            <td>{{ sale.unit_price }}</td>
            <td>{{ sale.quantity * sale.unit_price }}</td>
            <td>{{ sale.sale_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ sale.employee.name }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="addSaleModal" class="modal">
    <div class="modal-content">
        <h2>新增销售记录</h2>
        <form id="addSaleForm">
            <label for="product_id">商品:</label>
            <select id="product_id" name="product_id" required>
                {% for product in products %}
                <option value="{{ product.product_id }}">{{ product.name }}</option>
                {% endfor %}
            </select>

            <label for="quantity">数量:</label>
            <input type="number" id="quantity" name="quantity" required>

            <label for="unit_price">单价:</label>
            <input type="number" id="unit_price" name="unit_price" step="0.01" required>

            <label for="sale_date">销售日期:</label>
            <input type="date" id="sale_date" name="sale_date" required>

            <label for="employee_id">销售员:</label>
            <select id="employee_id" name="employee_id" required>
                {% for employee in employees %}
                <option value="{{ employee.employee_id }}">{{ employee.name }}</option>
                {% endfor %}
            </select>

            <button type="submit">保存</button>
            <button type="button" class="closeModal">取消</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 新增销售记录
    document.getElementById('addSaleBtn').addEventListener('click', function() {
        document.getElementById('addSaleModal').style.display = 'block';
    });

    document.getElementById('addSaleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch("{{ url_for('sale.add_sale') }}", {
            method: 'POST',
            body: new FormData(this)
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '新增销售记录失败');
            }
        });
    });

    // 搜索销售记录
    document.getElementById('searchSaleBtn').addEventListener('click', function() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const employeeId = document.getElementById('employeeFilter').value;
        fetch(`{{ url_for('sale.search_sale') }}?start_date=${startDate}&end_date=${endDate}&employee_id=${employeeId}`)
        .then(response => response.json())
        .then(sales => {
            const tbody = document.querySelector('#saleTable tbody');
            tbody.innerHTML = '';
            sales.forEach(sale => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${sale.id}</td>
                    <td>${sale.product_name}</td>
                    <td>${sale.quantity}</td>
                    <td>${sale.unit_price}</td>
                    <td>${sale.total_price}</td>
                    <td>${sale.sale_date}</td>
                    <td>${sale.employee_name}</td>
                `;
                tbody.appendChild(tr);
            });
        });

        // 更新销售统计
        fetch(`{{ url_for('sale.sale_statistics') }}?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalAmount').textContent = data.total_amount.toFixed(2);
            document.getElementById('totalQuantity').textContent = data.total_quantity;
        });
    });

    // 关闭模态框
    document.querySelectorAll('.closeModal').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
</script>
{% endblock %}